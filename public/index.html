<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Da Vinci - AI Email Sequence Creator</title>
        <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                background: #f9fafb;
                height: 100vh;
            }
            #app {
                height: 100vh;
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
                display: flex;
                flex-direction: column;
                background: white;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            }
            header {
                padding: 24px;
                border-bottom: 1px solid #e5e7eb;
                background: white;
            }
            h1 {
                font-size: 24px;
                font-weight: 600;
                color: #111827;
                margin-bottom: 4px;
            }
            .subtitle {
                color: #6b7280;
                font-size: 14px;
            }
            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .messages {
                flex: 1;
                overflow-y: auto;
                padding: 24px;
                background: #f9fafb;
            }
            .message {
                margin-bottom: 16px;
                display: flex;
                gap: 12px;
            }
            .message.user {
                flex-direction: row-reverse;
            }
            .bubble {
                max-width: 70%;
                padding: 12px 16px;
                border-radius: 18px;
                font-size: 15px;
                line-height: 1.4;
            }
            .bubble.user {
                background: #3b82f6;
                color: white;
                border-bottom-right-radius: 4px;
            }
            .bubble.ai,
            .bubble.model {
                background: white;
                color: #111827;
                border: 1px solid #e5e7eb;
                border-bottom-left-radius: 4px;
            }
            .bubble p {
                margin: 8px 0;
                line-height: 1.6;
            }
            .bubble p:first-child {
                margin-top: 0;
            }
            .bubble p:last-child {
                margin-bottom: 0;
            }
            .bubble hr {
                border: none;
                border-top: 2px solid #e5e7eb;
                margin: 16px 0;
            }
            .bubble h1,
            .bubble h2,
            .bubble h3 {
                margin: 16px 0 8px 0;
                font-weight: 600;
                line-height: 1.3;
                color: #111827;
            }
            .bubble h1:first-child,
            .bubble h2:first-child,
            .bubble h3:first-child {
                margin-top: 0;
            }
            .bubble h1 {
                font-size: 1.4em;
                border-bottom: 2px solid #e5e7eb;
                padding-bottom: 4px;
            }
            .bubble h2 {
                font-size: 1.25em;
            }
            .bubble h3 {
                font-size: 1.1em;
                color: #3b82f6;
            }
            .bubble strong {
                font-weight: 600;
                color: #1f2937;
            }
            .bubble em {
                font-style: italic;
                color: #4b5563;
            }
            .bubble strong em,
            .bubble em strong {
                font-weight: 600;
                font-style: italic;
                color: #111827;
            }
            .bubble ul,
            .bubble ol {
                margin: 12px 0;
                padding-left: 24px;
            }
            .bubble li {
                margin: 6px 0;
                line-height: 1.6;
            }
            .bubble code {
                background: #f3f4f6;
                padding: 2px 6px;
                border-radius: 3px;
                font-family: 'Courier New', monospace;
                font-size: 0.9em;
                color: #dc2626;
            }
            .bubble pre {
                background: #f9fafb;
                border: 1px solid #e5e7eb;
                padding: 12px;
                border-radius: 6px;
                overflow-x: auto;
                margin: 12px 0;
            }
            .bubble pre code {
                background: none;
                padding: 0;
                color: #111827;
            }
            .bubble a {
                color: #3b82f6;
                text-decoration: underline;
            }
            .bubble a:hover {
                color: #2563eb;
            }
            .input-area {
                padding: 16px;
                border-top: 1px solid #ddd;
                background: white;
            }
            .input-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            input[type="text"] {
                width: 100%;
                padding: 12px;
                height: 88px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
                outline: none;
                box-sizing: border-box;
            }
            input:focus {
                border-color: #3b82f6;
            }
            button {
                width: 100px;
                padding: 12px;
                height: 44px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 14px;
                cursor: pointer;
                align-self: flex-start;
            }
            button:hover:not(:disabled) {
                background: #2563eb;
            }
            button:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }
            .knowledge {
                position: absolute;
                bottom: 80px;
                right: 24px;
                background: #dbeafe;
                color: #1e40af;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
            }
            .loading {
                display: inline-block;
                width: 12px;
                height: 12px;
                border: 2px solid #e5e7eb;
                border-top: 2px solid #3b82f6;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
            .scrollbar::-webkit-scrollbar {
                width: 6px;
            }
            .scrollbar::-webkit-scrollbar-track {
                background: transparent;
            }
            .scrollbar::-webkit-scrollbar-thumb {
                background: #d1d5db;
                border-radius: 3px;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <header>
                <h1>Da Vinci</h1>
                <p class="subtitle">AI Email Sequence Creator</p>
            </header>
            <div class="chat-container">
                <div class="messages scrollbar" ref="messagesEl">
                    <div
                        v-for="(msg, index) in messages"
                        :key="index"
                        class="message"
                        :class="msg.role"
                    >
                        <div class="bubble" :class="msg.role" v-html="formatMessage(msg.content)"></div>
                    </div>
                    <div v-if="isLoading" class="message model">
                        <div class="bubble model">
                            <span class="loading"></span> Da Vinci is
                            thinking...
                        </div>
                    </div>
                </div>
                <div v-if="knowledgeIndicator" class="knowledge">
                    {{ knowledgeIndicator }}
                </div>
                <div class="input-area">
                    <div class="input-group">
                        <input
                            v-model="input"
                            @keypress.enter="sendMessage"
                            placeholder="Describe your business or paste website URL..."
                            :disabled="isLoading"
                        />
                        <button
                            @click="sendMessage"
                            :disabled="!input || isLoading"
                        >
                            {{ isLoading ? '...' : 'Send' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const { createApp, ref, computed, onMounted, nextTick } = Vue;

            createApp({
                setup() {
                    const messages = ref([]);
                    const input = ref("");
                    const isLoading = ref(false);
                    const messagesEl = ref(null);

                    // Backend API base URL (update for production)
                    const API_BASE = "http://localhost:8080";

                    const knowledgeIndicator = computed(() => {
                        const lastMsg =
                            messages.value[messages.value.length - 1];
                        if (lastMsg?.vertical) {
                            return `Knowledge: ${lastMsg.vertical}`;
                        }
                        return "";
                    });

                    // Format message content with markdown-like formatting
                    const formatMessage = (text) => {
                        if (!text) return "";
                        
                        let formatted = text;
                        
                        // Escape HTML to prevent XSS first
                        formatted = formatted
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;");
                        
                        // Normalize line breaks (handle both \n and \r\n)
                        formatted = formatted.replace(/\r\n/g, "\n");
                        
                        // Handle horizontal rules (--- or ***)
                        formatted = formatted.replace(/^---+$/gm, "<hr>");
                        formatted = formatted.replace(/^\*\*\*+$/gm, "<hr>");
                        
                        // Split into lines for better processing
                        const lines = formatted.split("\n");
                        let result = [];
                        let inList = false;
                        let inCodeBlock = false;
                        let codeBlockContent = [];
                        
                        for (let i = 0; i < lines.length; i++) {
                            let line = lines[i];
                            
                            // Handle code blocks
                            if (line.trim().startsWith("```")) {
                                if (inCodeBlock) {
                                    result.push("<pre><code>" + codeBlockContent.join("\n") + "</code></pre>");
                                    codeBlockContent = [];
                                    inCodeBlock = false;
                                } else {
                                    if (inList) {
                                        result.push("</ul>");
                                        inList = false;
                                    }
                                    inCodeBlock = true;
                                }
                                continue;
                            }
                            
                            if (inCodeBlock) {
                                codeBlockContent.push(line);
                                continue;
                            }
                            
                            // Handle horizontal rules
                            if (line.trim() === "<hr>" || line.match(/^---+$/)) {
                                if (inList) {
                                    result.push("</ul>");
                                    inList = false;
                                }
                                result.push("<hr>");
                                continue;
                            }
                            
                            // Handle headers
                            if (line.match(/^###\s+/)) {
                                if (inList) {
                                    result.push("</ul>");
                                    inList = false;
                                }
                                result.push("<h3>" + line.replace(/^###\s+/, "") + "</h3>");
                                continue;
                            }
                            if (line.match(/^##\s+/)) {
                                if (inList) {
                                    result.push("</ul>");
                                    inList = false;
                                }
                                result.push("<h2>" + line.replace(/^##\s+/, "") + "</h2>");
                                continue;
                            }
                            if (line.match(/^#\s+/)) {
                                if (inList) {
                                    result.push("</ul>");
                                    inList = false;
                                }
                                result.push("<h1>" + line.replace(/^#\s+/, "") + "</h1>");
                                continue;
                            }
                            
                            // Handle lists
                            const bulletMatch = line.match(/^[-•]\s+(.+)$/);
                            const numberMatch = line.match(/^\d+\.\s+(.+)$/);
                            
                            if (bulletMatch || numberMatch) {
                                if (!inList) {
                                    result.push("<ul>");
                                    inList = true;
                                }
                                const content = bulletMatch ? bulletMatch[1] : numberMatch[1];
                                result.push("<li>" + formatInlineMarkdown(content) + "</li>");
                                continue;
                            }
                            
                            if (inList) {
                                result.push("</ul>");
                                inList = false;
                            }
                            
                            // Handle empty lines as paragraph breaks
                            if (line.trim() === "") {
                                result.push("<br>");
                                continue;
                            }
                            
                            // Regular line - apply inline formatting
                            result.push("<p>" + formatInlineMarkdown(line) + "</p>");
                        }
                        
                        if (inList) {
                            result.push("</ul>");
                        }
                        if (inCodeBlock) {
                            result.push("<pre><code>" + codeBlockContent.join("\n") + "</code></pre>");
                        }
                        
                        formatted = result.join("");
                        
                        // Clean up consecutive <br> tags
                        formatted = formatted.replace(/(<br>\s*){3,}/g, "<br><br>");
                        
                        return formatted;
                    };
                    
                    // Format inline markdown (bold, italic, code, links)
                    const formatInlineMarkdown = (text) => {
                        if (!text) return "";
                        
                        let formatted = text;
                        
                        // Code blocks (```code```) - should be handled before inline
                        formatted = formatted.replace(/```([^`]+)```/g, "<pre><code>$1</code></pre>");
                        
                        // Inline code (`code`)
                        formatted = formatted.replace(/`([^`]+)`/g, "<code>$1</code>");
                        
                        // Bold and italic: ***text*** → <strong><em>text</em></strong>
                        formatted = formatted.replace(/\*\*\*(.*?)\*\*\*/g, "<strong><em>$1</em></strong>");
                        
                        // Bold: **text** → <strong>text</strong>
                        formatted = formatted.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
                        
                        // Italic: *text* (but not if preceded/followed by *)
                        formatted = formatted.replace(/(^|[^*])\*([^*\s][^*]*?[^*\s])\*([^*]|$)/g, "$1<em>$2</em>$3");
                        
                        // Links [text](url)
                        formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
                        
                        return formatted;
                    };

                    const sendMessage = async () => {
                        if (!input.value.trim() || isLoading.value) return;

                        const userMsg = input.value.trim();
                        messages.value.push({ role: "user", content: userMsg });
                        input.value = "";
                        isLoading.value = true;

                        // Scroll to bottom
                        await nextTick();
                        messagesEl.value.scrollTop =
                            messagesEl.value.scrollHeight;

                        try {
                            const response = await fetch(`${API_BASE}/api/chat`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    currentMessage: userMsg,
                                    conversationHistory: messages.value
                                        .slice(0, -1) // Exclude the user message we just added
                                        .map((msg) => ({
                                            role: msg.role,
                                            content: msg.content,
                                        })),
                                }),
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(
                                    `Server error: ${response.status} - ${errorText}`
                                );
                            }

                            const data = await response.json();
                            messages.value.push({
                                role: "model",
                                content: data.message || "No response from server",
                                vertical: data.identifiedVertical,
                                step: data.workflowStep,
                            });
                        } catch (error) {
                            console.error("Error sending message:", error);
                            let errorMsg = "Sorry, having trouble connecting.";
                            if (error.message.includes("503") || error.message.includes("overloaded")) {
                                errorMsg = "The AI service is temporarily overloaded. Please try again in a few moments.";
                            } else if (error.message.includes("429") || error.message.includes("rate limit")) {
                                errorMsg = "Too many requests. Please wait a moment and try again.";
                            } else {
                                errorMsg += " " + error.message;
                            }
                            messages.value.push({
                                role: "model",
                                content: errorMsg,
                            });
                        }

                        isLoading.value = false;
                        // Scroll to bottom
                        await nextTick();
                        messagesEl.value.scrollTop =
                            messagesEl.value.scrollHeight;
                    };

                    onMounted(() => {
                        // Welcome message
                        messages.value.push({
                            role: "model",
                            content:
                                "Hi, I'm Da Vinci, The Automated Email Sequence Creator. Let me ask you a few questions to get started.",
                        });
                    });

                    return {
                        messages,
                        input,
                        isLoading,
                        messagesEl,
                        knowledgeIndicator,
                        sendMessage,
                        formatMessage,
                    };
                },
            }).mount("#app");
        </script>
    </body>
</html>
